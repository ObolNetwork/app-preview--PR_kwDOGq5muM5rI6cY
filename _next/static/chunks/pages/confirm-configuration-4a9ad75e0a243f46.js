(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8489],{84679:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/confirm-configuration",function(){return s(71075)}])},71075:function(e,t,s){"use strict";s.r(t);var a=s(85893),r=s(67294),i=s(24967),n=s(61472),l=s(86105),o=s(98682),c=s(87536),d=s(15497),h=s(31431),u=s(11163),p=s(59600),x=s(70521),g=s(69671),m=s(48497),f=s(91997),v=s(12606),j=s(37122),w=s(92321),y=s(27773),C=s(37003);let ConfirmConfiguration=()=>{let e,t;let s=(0,j.Z)(),{address:S,chainId:_}=(0,w.m)(),b=(0,y.t)(),{handleSubmit:k}=(0,c.cI)({mode:"onChange"}),A=(0,u.useRouter)(),[R,E]=(0,r.useState)(),[$,N]=(0,r.useState)(),[O,T]=(0,r.useState)(!1),[D,I]=(0,r.useState)(""),[W,F]=(0,r.useState)(),[P,z]=(0,r.useState)(),[K,X]=(0,r.useState)(!1),[Z,H]=(0,r.useState)(""),L="v1.8.0",[M,J]=(0,r.useState)(!1),[U,Y]=(0,r.useState)(""),[Q,V]=(0,r.useState)(""),q=(0,o.o)(e=>e.clusterDefinition),B=(null==q?void 0:q.withdrawalConfigType)==="reward_splitter",G=(null==q?void 0:q.withdrawalConfigType)==="splitter",ee=(null==q?void 0:q.withdrawalConfigType)==="custom"||(null==q?void 0:q.withdrawalConfigType)==="lido";B?(e="Rewards",t="Deploy 'Split Rewards' Contract"):G&&(e="Principal & Rewards",t="Deploy 'Split Everything' Contract");let et=null==q?void 0:q.operators.some(e=>e.address===S),es=(0,o.o)(e=>e.updateClusterDefinition),ea=(0,o.o)(e=>e.completeLeaderStep),er=(0,o.o)(e=>e.enableLeaderStep),clearState=()=>{E(null),N(null),I(""),F(""),z(""),T(!1)},catchError=e=>{console.log(e),clearState()},postCall=async e=>{let t=await (0,h.c0)({token:e,data:R});if(!t.data.config_hash)throw"no config hash returned";I(t.data.config_hash)};(0,r.useEffect)(()=>{if(R){let createConfig=async()=>{try{let e={creator_config_hash:R.config_hash},t=await (0,d.L6)(_,S,e,s);if(await postCall(t),et){let e={operator_config_hash:R.config_hash},t=await (0,d.AM)(_,S,e,s);z(t);let a={enr:null==q?void 0:q.enr},r=await (0,d.Ol)(_,S,a,s);F(r)}}catch(e){catchError(e)}};createConfig()}},[R]),(0,r.useEffect)(()=>{if(et&&$&&D||!et&&D){ea("confirm-configuration");let e=er("invite-group");T(!1),A.push({pathname:e.href,query:{configHash:D}})}},[$,D]),(0,r.useEffect)(()=>{if(et&&W&&P&&D){let putCall=async()=>{let e={address:S,enr:null==q?void 0:q.enr,enr_signature:W,fork_version:l.se,version:L},{data:t}=await (0,h.R)({token:P,data:e,configHash:D});N(t)};putCall().catch(catchError)}},[W,D]);let OperatorsStatusSection=()=>(0,a.jsx)(n.W2,{className:"cluster-details",alignItems:"start",children:(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$2xl"},children:[(0,a.jsx)(f.uo,{}),(0,a.jsx)(i.VL,{operators:[...null==q?void 0:q.operators],connectedAddress:S})]})}),ENRSection=()=>(0,a.jsxs)(n.W2,{className:"enr-section",alignItems:"start",css:{gap:"$lg"},children:[(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$sm"},children:[(0,a.jsxs)(n.kC,{css:{alignItems:"center",gap:"$xxxs"},children:[(0,a.jsx)(n.xv,{variant:"subline",color:"body",css:{textTransform:"uppercase"},children:"Your Charon client ENR"}),(0,a.jsx)(n.KZ,{content:'An ENR is an "Ethereum Node Record" used to identify your client to the other clients in the cluster"',children:(0,a.jsx)(n.xu,{css:{display:"flex"},children:(0,a.jsx)(n.by,{})})})]}),(0,a.jsx)(i.Kx,{css:{minHeight:"115px"},placeholder:"Your enr",value:null==q?void 0:q.enr,readOnly:!0})]}),(0,a.jsxs)(n.rU,{href:"https://docs.obol.org/next/learn/charon/cluster-configuration#cluster-size-and-resilience/start/quickstart_group#step-1-generate-an-enr",target:"_blank",children:["More on Ethereum Node Records ",(0,a.jsx)(n.ZJ,{})]})]}),deploySplitterContract=async e=>{let{recipientsAddresses:t,splitPercentages:a}=e;try{let e=await (0,m.s8)(t,a,s);console.log("realSplitAddress",e),es({...q,validators:Array(q.validatorsSize).fill({feeRecipientAddress:e,withdrawalAddress:e})}),H(e);return}catch(t){let e=(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)?(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)[0]:null==t?void 0:t.message;throw e}},deployMultiCallContract=async e=>{let{recipientsAddresses:t,splitPercentages:a,predictedSplitAddress:r}=e;try{let{owrAddress:e,splitAddress:i}=await (0,m.KZ)({principalRecipient:q.principal,amountOfPrincipalStake:32*q.validatorsSize},{accounts:t,percentAllocations:a},r,s);es({...q,validators:Array(q.validatorsSize).fill({feeRecipientAddress:i,withdrawalAddress:e})}),H(i);return}catch(t){let e=(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)?(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)[0]:null==t?void 0:t.message;throw e}},deployOWRFactoryContract=async e=>{try{let t=await (0,m.Sf)(q.principal,e,32*q.validatorsSize,s);console.log(t,"OWRecipientContractAddresses"),es({...q,validators:Array(q.validatorsSize).fill({feeRecipientAddress:e,withdrawalAddress:t})}),H(e);return}catch(t){let e=(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)?(null==t?void 0:t.message).match(/^(.*?)(?=\s*\()/)[0]:null==t?void 0:t.message;throw e}},handleOnDeploySplitter=async e=>{if(e.preventDefault(),!K){Y(""),X(!0);try{let e=await (0,d.jT)(l.nU,b),t=await (0,d.jT)(l.wi,b),a=await (0,d.jT)(l.eh,b);if(!e||!t||!a){Y(l.dK),X(!1);return}let r=[...q.recipients];r.sort((e,t)=>e.address.localeCompare(t.address));let i=r.map(e=>e.address).filter(e=>""!==e),n=r.map(e=>{let t=(1e4*parseFloat(e.split)).toFixed(0);return parseInt(t)}),o=await (0,C.L)(s,{abi:g.s,address:l.wi,functionName:"predictImmutableSplitAddress",args:[i,n,l.Uu]}),c=await (0,m.Kv)(o,_);console.log(c,"isSplitterDeployed"),B?c?(await deployOWRFactoryContract(o),V(l.Oy)):await deployMultiCallContract({recipientsAddresses:i,splitPercentages:n,predictedSplitAddress:o}):G&&(c?(es({...q,validators:Array(q.validatorsSize).fill({feeRecipientAddress:o,withdrawalAddress:o})}),H(o),V(l.Oy)):await deploySplitterContract({recipientsAddresses:i,splitPercentages:n})),X(!1)}catch(e){X(!1),Y(e)}}},ei=(0,r.useMemo)(()=>(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(OperatorsStatusSection,{}),(0,a.jsx)(f.XD,{}),et&&(0,a.jsx)(ENRSection,{}),(0,a.jsxs)(n.W2,{className:"withdrawal-section",css:{gap:"$xl"},alignItems:"start",children:[(0,a.jsx)(n.xv,{variant:"h4",children:"Withdrawal Configuration"}),"Rewards"===e&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(f.nB,{heading:"Principal Address",description:"Address to receive skimming rewards and validator principal at exit.",value:null==q?void 0:q.principal,className:"principal-address-section"}),(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$xs"},children:[(0,a.jsxs)(n.xv,{variant:"h5",children:[e," Split"]}),(0,a.jsx)(n.xv,{color:"body",variant:"body",children:"Split validator rewards among cluster recipients (note that 1% is allocated to the Obol Collective)."}),(0,a.jsx)(p.I,{recipients:q.recipients,type:e})]}),Z&&(0,a.jsxs)(n.W2,{variant:"card",className:"enr-section",alignItems:"start",css:{gap:"$sm",padding:"$sm"},children:[(0,a.jsxs)(n.kC,{css:{gap:"$sm"},children:[(0,a.jsx)(n.xu,{children:(0,a.jsx)(n.nQ,{})}),(0,a.jsx)(n.xu,{css:{display:"flex",flexDirection:"column",gap:"$xs"},children:(0,a.jsx)(n.xv,{variant:"body",css:{color:"white"},children:"Optimistic Withdrawal Recipient Contract Successfully Deployed"})})]}),(0,a.jsx)(n.xv,{color:"body",variant:"subline",css:{lineHeight:"$lg",textTransform:"uppercase",letterSpacing:"1px"},children:"Optimistic Withdrawal Recipient Contract Address"}),(0,a.jsx)(n.IK,{readOnly:!0,value:q.validators[0].withdrawalAddress}),(0,a.jsxs)(n.rU,{href:"".concat(l.jX,"/address/").concat(q.validators[0].withdrawalAddress,"#code"),target:"_blank",children:["View on Etherscan ",(0,a.jsx)(n.ZJ,{})]})]})]}),"Principal & Rewards"===e&&(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$xs"},children:[(0,a.jsxs)(n.xv,{variant:"h5",children:[e," Split"]}),(0,a.jsx)(n.xv,{color:"body",variant:"body",children:"Split validator rewards and principal among cluster recipients (note that 1% is allocated to the Obol Collective)."}),(0,a.jsx)(p.I,{recipients:q.recipients,type:e,validatorsSize:q.validators.length})]}),Z&&(0,a.jsxs)(n.W2,{variant:"card",className:"enr-section",alignItems:"start",css:{gap:"$sm",padding:"$sm"},children:[(0,a.jsxs)(n.kC,{css:{gap:"$sm"},children:[(0,a.jsx)(n.xu,{children:(0,a.jsx)(n.nQ,{})}),(0,a.jsx)(n.xu,{css:{display:"flex",flexDirection:"column",gap:"$xs"},children:(0,a.jsx)(n.xv,{variant:"body",css:{color:"white"},children:"Splitter Proxy Contract Successfully Deployed"})})]}),(0,a.jsx)(n.xv,{color:"body",variant:"subline",css:{lineHeight:"$lg",textTransform:"uppercase",letterSpacing:"1px"},children:"Splitter Proxy Contract Address"}),(0,a.jsx)(n.IK,{readOnly:!0,value:Z}),(0,a.jsxs)(n.rU,{href:"".concat(l.jX,"/address/").concat(Z,"#code"),target:"_blank",children:["View on Etherscan ",(0,a.jsx)(n.ZJ,{})]})]}),!Z&&(0,a.jsx)(i.fl,{color:"primary",type:"button",onClick:handleOnDeploySplitter,children:(0,a.jsxs)(a.Fragment,{children:[K&&(0,a.jsx)(n.yC,{}),t]})}),Q&&(0,a.jsx)(n.xv,{variant:"metadata",color:"testHover",children:Q}),U&&(0,a.jsx)(n.xv,{variant:"metadata",color:"test",children:U})]})]}),[Z,K,U,q]),en=(0,r.useMemo)(()=>(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(OperatorsStatusSection,{}),(0,a.jsx)(f.XD,{}),et&&(0,a.jsx)(ENRSection,{}),(0,a.jsx)(v.EJ,{singleAddress:null==q?void 0:q.singleAddress,feeRecipientAddress:null==q?void 0:q.feeRecipientAddress})]}),[q]);if(!q)return(0,a.jsx)(n.xv,{children:"No cluster data ..."});let onSubmit=async()=>{if(O)return;console.log(JSON.stringify(q),"currentClusterData");let e=(0,d.KH)(q,L);console.log(e.config_hash,"config_hashconfig_hash"),E(e),T(!0)};return(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$2xl"},children:[(0,a.jsx)(n.xv,{variant:"h3",children:"Confirm Configuration"}),(0,a.jsx)(i.l0,{onSubmit:k(onSubmit),children:(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$2xl"},children:[(0,a.jsx)(x.T,{name:"reward_split_withdrawal_flow",children:B&&ei}),(0,a.jsx)(x.T,{name:"split_withdrawal_flow",children:G&&ei}),(0,a.jsx)(x.T,{name:"single_withdrawal_address_flow",children:ee&&en}),(0,a.jsx)(n.kC,{direction:"column",css:{gap:"$lg"},children:(0,a.jsxs)(n.W2,{className:"enr-section",alignItems:"start",css:{gap:"$lg"},children:[(0,a.jsx)(n.kC,{direction:"column",css:{gap:"$xs"},children:(0,a.jsx)(n.xv,{variant:"h4",children:"Confirm Details "})}),(0,a.jsxs)(n.kC,{direction:"column",css:{gap:"$xl"},children:[(0,a.jsxs)(n.kC,{css:{gap:"$xs",width:"$full"},children:[(0,a.jsx)(n.xu,{children:(0,a.jsx)(n.XZ,{checked:M,onCheckedChange:()=>J(!M)})}),(0,a.jsx)(n.xv,{variant:"body",children:"You will be prompted to sign a message with your wallet. This signature is attesting to the fact that:"})]}),(0,a.jsx)(n.sQ,{heading:"You have confirmed the withdrawal address for the validators to be created is correct. If this address is a contract, you have confirmed the contract implementation is correct. If this address is an externally-owned account, you have confirmed that the EOA custody is secure."}),(0,a.jsx)(n.sQ,{heading:"You have submitted your charon node's Ethereum Node Record (ENR) correctly. This signature is the authorisation of this charon client to act on your behalf."})]}),(0,a.jsx)(i.fl,{color:"primary",type:"submit",disabled:!ee&&!Z||!M,children:(0,a.jsxs)(a.Fragment,{children:[O&&(0,a.jsx)(n.yC,{}),"Confirm and Sign"]})})]})})]})})]})};t.default=ConfirmConfiguration,ConfirmConfiguration.layout="ProgressTrackerLayout"}},function(e){e.O(0,[9774,2888,179],function(){return e(e.s=84679)}),_N_E=e.O()}]);